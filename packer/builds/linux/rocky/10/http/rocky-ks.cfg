#version=RHEL10
# Rocky Linux 10 Kickstart Configuration

# System authorization information
auth --enableshadow --passalgo=sha512

# Use network installation
url --url="https://download.rockylinux.org/pub/rocky/10/BaseOS/x86_64/os/"

# Use text mode install
text

# Run the Setup Agent on first boot
firstboot --enable

ignoredisk --only-use=sda

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'

# System language
lang en_US.UTF-8

# Network information
network --bootproto=dhcp --device=eth0 --ipv6=auto --activate
network --hostname=rocky10-template

# Root password (you may want to change this)
rootpw --iscrypted $6$rounds=4096$salt$hashedpassword

# System services
services --enabled="chronyd,sshd,qemu-guest-agent"

# System timezone
timezone UTC --isUtc

# System bootloader configuration
bootloader --append=" crashkernel=auto" --location=mbr --boot-drive=sda

# Partition clearing information
clearpart --none --initlabel

# Disk partitioning information
part /boot --fstype="xfs" --ondisk=sda --size=1024
part pv.157 --fstype="lvmpv" --ondisk=sda --grow
volgroup rocky --pesize=4096 pv.157
logvol / --fstype="xfs" --size=18432 --name=root --vgname=rocky
logvol swap --fstype="swap" --size=1024 --name=swap --vgname=rocky

# Package selection
%packages
@^minimal-environment
@standard
chrony
cloud-init
cloud-utils-growpart
qemu-guest-agent
openssh-server
sudo
wget
curl
vim
python3
python3-pip
-firewalld
%end

# Add user
user --groups=wheel --name=rocky --password=$6$rounds=4096$salt$hashedpassword --iscrypted --gecos="Rocky User"

%post
# Enable sudo for rocky user
echo "rocky ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/rocky

# Enable cloud-init services
systemctl enable cloud-init
systemctl enable cloud-init-local
systemctl enable cloud-config
systemctl enable cloud-final

# Enable qemu-guest-agent
systemctl enable qemu-guest-agent

# Configure SSH
sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Clean up
dnf clean all
%end

# Reboot after installation
reboot
