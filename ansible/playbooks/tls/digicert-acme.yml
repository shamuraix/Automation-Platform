---
# DigiCert ACME TLS automation task file
# This file implements the DigiCert ACME flow using community.crypto modules
# Runs on the Ansible controller (localhost) via delegation from the parent play

- name: Validate ACME configuration
  ansible.builtin.assert:
    that:
      - acme_contact_email | length > 0
      - acme_eab_kid | length > 0
      - acme_eab_key | length > 0
    fail_msg: "ACME configuration incomplete: acme_contact_email, acme_eab_kid, and acme_eab_key must be set"
    success_msg: "ACME configuration validated successfully"
  tags: ['digicert', 'acme', 'tls']

- name: Ensure ACME data directory exists on controller
  ansible.builtin.file:
    path: "{{ acme_data_dir }}"
    state: directory
    mode: '0700'
  tags: ['digicert', 'acme', 'tls']

- name: Create ACME account key
  community.crypto.openssl_privatekey:
    path: "{{ acme_data_dir }}/acme-account.key"
    type: RSA
    size: 2048
    mode: '0600'
  no_log: true
  tags: ['digicert', 'acme', 'tls']

- name: Create ACME account with EAB (External Account Binding)
  community.crypto.acme_account:
    account_key_src: "{{ acme_data_dir }}/acme-account.key"
    acme_directory: "{{ acme_directory_url }}"
    acme_version: 2
    terms_agreed: true
    external_account_binding:
      kid: "{{ acme_eab_kid }}"
      alg: "{{ acme_eab_alg }}"
      key: "{{ acme_eab_key }}"
    contact:
      - "mailto:{{ acme_contact_email }}"
    state: present
  no_log: true
  tags: ['digicert', 'acme', 'tls']

- name: Generate certificate private key
  community.crypto.openssl_privatekey:
    path: "{{ acme_data_dir }}/{{ acme_cert_cn }}.key"
    type: RSA
    size: 2048
    mode: '0600'
  no_log: true
  tags: ['digicert', 'acme', 'tls']

- name: Generate Certificate Signing Request (CSR)
  community.crypto.openssl_csr:
    path: "{{ acme_data_dir }}/{{ acme_cert_cn }}.csr"
    privatekey_path: "{{ acme_data_dir }}/{{ acme_cert_cn }}.key"
    common_name: "{{ acme_cert_cn }}"
    subject_alt_name: "{{ acme_subject_alt_name }}"
  tags: ['digicert', 'acme', 'tls']

- name: Request certificate via ACME (with http-01 challenge)
  # NOTE: http-01 challenge requires port 80 to be accessible from the internet
  # and a web server to serve challenge files from /.well-known/acme-challenge/
  # for domain validation to succeed. Ensure your infrastructure supports this.
  community.crypto.acme_certificate:
    account_key_src: "{{ acme_data_dir }}/acme-account.key"
    account_email: "{{ acme_contact_email }}"
    acme_directory: "{{ acme_directory_url }}"
    acme_version: 2
    csr: "{{ acme_data_dir }}/{{ acme_cert_cn }}.csr"
    dest: "{{ acme_data_dir }}/{{ acme_cert_cn }}.pem"
    fullchain_dest: "{{ acme_data_dir }}/{{ acme_cert_cn }}-fullchain.pem"
    chain_dest: "{{ acme_data_dir }}/{{ acme_cert_cn }}-chain.pem"
    challenge: http-01
    force: true
    remaining_days: 10
    terms_agreed: true
  register: acme_challenge_result
  tags: ['digicert', 'acme', 'tls']

- name: Display ACME challenge information
  ansible.builtin.debug:
    msg: "ACME certificate issuance completed successfully for {{ acme_cert_cn }}"
  when: acme_challenge_result.changed
  tags: ['digicert', 'acme', 'tls']
